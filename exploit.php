<?php

  include_once("./sql.php");

  // Attention à respecter la casse !!

  function Parrainage(&$con, $filiere)
  {
    try
    {

      // Sélection des niveau 1
      
      $stmt = $con->prepare('SELECT matricule FROM etudiants WHERE niveau = 1 AND filiere = "' . trim($filiere) . '"');
      $stmt->execute();
      $filleuls = $stmt->fetchAll(PDO::FETCH_NUM);
      $count1 = count($filleuls);
      
      $stmt = null;

      // Sélection des niveau 2

      $stmt = $con->prepare('SELECT matricule FROM etudiants WHERE niveau = 2 AND filiere = "' . trim($filiere) . '"');
      $stmt->execute();
      $parrains = $stmt->fetchAll(PDO::FETCH_NUM);
      $count2 = count($parrains);
      
      $stmt = null;

      $maxCount = ($count1 > $count2) ? $count1 : $count2;
      $minCount = ($maxCount === $count1) ? $count2 : $count1;
      
      
      // Tableau chargé de contenir les parrains supplémentaires pour ceux qui n'en ont pas eu (Un parrain aura plusieurs filleuls)

      $bonusArray = [];
          
      // $offset permet d'éviter de choisir un parrain plus de fois que nécessaire (il détermine le point le départ pour la sélection de parrains supplémentaires)

      $offset = 0;  
      
      // Ranger le tableau de façon aléatoire

      shuffle($parrains);

      // $diff va contenir le nombre de filleuls qui n'ont toujours pas de parrains
       
      $diffcount = $maxCount - $minCount;

      // Ici on ajoute le parrains supplémentaires dans le tableau $bonusArray
      
      do
      {
        $diff = ($diffcount < $minCount) ? $diffcount : $diffcount - $minCount;
        $bonusArray = array_merge($bonusArray, array_slice($parrains, $offset, $diff));
        $offset += $diffcount;
        $diffcount -= $diff;
      }
      while($diffcount > 0);

      unset($diffcount);
      unset($offset);

      // On ajoute finalement les parrains supplémentaires de $bonusArray dans le tableau initial $parrains
      
      $count = count($bonusArray);
      for ($i = 0; $i < $count; $i++)
      {
        array_push($parrains, $bonusArray[$i]);
      }

      unset($count);

      // AFFICHAGE DES RESULTATS 

      echo '<table border="4">
              <tr>
                <th></th>
                <th colspan="2">Noms & Prénoms</th>
              </tr>
              <tr>
               <th>N<sup>o</sup></th>
                <th>Filleuls</th>
                <th>Parrains</th>
              </tr>
      ';

      for($i = 0;  $i < $maxCount; $i++)
      {
        $filleuls[$i] = $filleuls[$i][0]; 
        $parrains[$i] = $parrains[$i][0]; 
        $td0 = "<td>$i</td>";
        // $td2 = ($i >= $count2) ? "<td></td>" : ("<td>" . $parrains[$i][0] ."</td>");
        // $td2 = ($i >= $count2) ? "<td></td>" : ("<td>" . $parrains[$i][0] ."</td>");
        $td1 = "<td>" . $filleuls[$i]  . "</td>";
        $td2 = "<td>" . $parrains[$i] . "</td>";
        // MISE À JOUR DANS LA BD des MatriculeParrain

        $stmt = $con->prepare('UPDATE etudiants SET matricule_parrain = ? WHERE matricule  = ?');
        $stmt->execute(array($parrains[$i], $filleuls[$i]));
        /*for ($i = 0; $i < $maxCount; $i++)
        {
          $stmt->execute(array($parrains[$i][0], $filleuls[$i][0]));
        }*/

        send_mail($filleuls[$i]);
        
        echo "<tr>$td0$td1$td2<tr />";
       
      }
      echo '</table>';

      // **Test** : Affiche les parrains ainsi que le nombre de filleuls qu'ils devront prendre en charge
      //print_r(array_count_values($parrains));
      
      // print_r($filleuls);
      // print_r($parrains);


      
      $stmt = null;
      
      ////FIN/////
    
    }
    catch(PDOException $e)
    {
      echo "<br />Echec de la requete : " . $e->getMessage() . "<br />";
    }
    catch(Exception $e)
    {
      echo "<br />Echec de la requete : " . $e->getMessage() . "<br />"; 
    }

    function send_mail($filleul) {
      $stmt1 = $con->prepare('SELECT * FROM etudiants RIGHT JOIN etudiants ON etudiants.matricule_parrain=etudiants.matricule WHERE matricule = ?');
      $stmt1->execute([$filleul]);
      $row = $stmt1->fetch();

      /* Création du header de l'e-mail */ 
      $header = "From: no-reply@oncheckcm.com\n";
      $header .= "MIME-version: 1.0\n";
      $header .= "Content-type: text/html; charset=utf-8\n";
      $header .= "Content-Transfer-ncoding: 8bit";

      $contenu = '
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta http-equiv="X-UA-Compatible" content="IE=edge">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Document</title>
            <link rel="stylesheet" type="text/css"
                href="//fonts.googleapis.com/css?family=Montserrat:300,400,700%7CPoppins:300,400,500,700,900">
            <link rel="stylesheet" href="css/bootstrap.css">
            <link rel="stylesheet" href="css/fonts.css">
            <link rel="stylesheet" href="css/style.css">
        
            <style>
                h3.title {
                    text-decoration: underline;
                    text-align: center;
                    font-weight: bold;
                    margin-bottom: 30px;
                }
        
                h4 {
                    text-align: center;
                }
        
                footer {
                    margin-top: 30px;
                    align-items: center;
                    justify-content: center;
                    text-align: center;
                }
                footer a {
                    color: rgb(56, 56, 213);
                }
                footer a:hover {
                    text-decoration: underline;
                }
            </style>
        </head>
        <body>
            <div>
                <h3 class="title">RESULTAT DU PARRAINAGE</h3>
                <div class="card" style="width: 25rem; margin-bottom: 3rem;">
                    <h4>Informations sur le parrain :</h4>
                    <img src="images/'.$row['image'][0].'" style="width: 100%; height: 300px;" class="card-img-top" alt="...">
                    
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item"><h3><b>Noms:</b> '.$row['noms'][0].'</h3></li>
                        <li class="list-group-item"><h3><b>Téléphone:</b> '.$row['telephone'][0].'</h3></li>
                        <li class="list-group-item"><h3><b>Filière:</b> '.$row['filiere'][0].'</h3></li>
                        <li class="list-group-item"><h3><b>Niveau:</b> '.$row['niveau'][0].'</h3></li>
                        <li class="list-group-item"><h3><b>Email:</b> '.$row['email'][0].'</h3></li>
                    </ul>
                    
                </div>
                <div class="card" style="width: 25rem;">
                    <h4>Informations sur le filleul :</h4>
                    <img src="images/'.$row['image'][1].'" style="width: 100%; height: 300px;" class="card-img-top" alt="...">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item"><h3><b>Nom:</b> '.$row['noms'][1].'</h3></li>
                        <li class="list-group-item"><h3><b>Téléphone:</b> '.$row['telephone'][1].'</h3></li>
                        <li class="list-group-item"><h3><b>Filière:</b> '.$row['filiere'][1].'</h3></li>
                        <li class="list-group-item"><h3><b>Niveau:</b> '.$row['niveau'][1].'</h3></li>
                        <li class="list-group-item"><h3><b>Email:</b> '.$row['email'][1].'</h3></li>
                    </ul>
                </div>
        
                <footer>
                    <h5>Bonne collaboration et année académique !</h5>
                    <h5>&copy; 2022-2023 Designed By <a href="https://www.oncheckcm.com/yantech/index">Yehiel Yanou</a></h5>
                </footer>
            </div>
        </body>
        </html>
      ';

      mail($row['email'][0], 'Parrainage 2022-2023', $contenu, $header);
      mail($row['email'][1], 'Parrainage 2022-2023', $contenu, $header);

    }
  } 



  Connect($con, "parrainage-2022");
  // SQLInsertFromCSV("localhost", "parrainage2", "root", "", "../Etudiants IUC/ToCSV/TEL1.csv", "Etudiant", "FiliereEtudiant, NiveauEtudiant, MatriculeEtudiant, NomEtudiant", 4);
  // SQLInsertFromCSV("localhost", "parrainage2", "root", "", "../Etudiants IUC/ToCSV/TEL2.csv", "Etudiant", "FiliereEtudiant, NiveauEtudiant, MatriculeEtudiant, NomEtudiant", 4);
  Parrainage($con, "ECMN");

  $con = null;


?>